I"òe<blockquote>
  <ul>
    <li>ç›®å½•ï¼š</li>
  </ul>
  <div id="toc"></div>
</blockquote>

<ul>
  <li>
    <p>å­¦ä¹ çš„åŸå› </p>

    <p><strong>Tomcat</strong>æ˜¯å¸¸ç”¨çš„webå®¹å™¨ï¼Œå®ç°äº†servletè§„èŒƒï¼Œç°åœ¨æµè¡Œçš„springæ¡†æ¶å†…éƒ¨ä¹Ÿé›†æˆäº†<strong>Tomcat</strong>ï¼Œå¯è§å…¶çš„é‡è¦æ€§ã€‚<strong>Tomcat</strong>æ˜¯éå¸¸å€¼å¾—å¤§å®¶ç ”ç©¶å­¦ä¹ çš„ä¸€ä¸ªæ¡†æ¶ï¼Œé‡Œé¢æ¶‰åŠåˆ°Javaçš„å„æ–¹é¢çš„çŸ¥è¯†ï¼Œæ¯”å¦‚è®¾è®¡æ¨¡å¼ã€ç»„ä»¶åŒ–ç¼–ç¨‹ã€å¤šçº¿ç¨‹ã€IOåŠNIOçš„è¿ç”¨ã€ç½‘ç»œSocketç¼–ç¨‹ç­‰ç­‰ï¼Œé€šè¿‡Tomcatä¸ä»…å¯ä»¥å¯¹Javaé«˜çº§ç‰¹æ€§çš„è¿ç”¨ä»æ–‡å­—è½¬åŒ–åˆ°å…·ä½“åº”ç”¨çš„å½¢å¼ï¼Œè€Œä¸”å¯¹è‡ªå·±ä»¥åçš„ä»£ç è®¾è®¡æ–¹é¢ä¹Ÿä¼šæœ‰å¾ˆå¤šæé«˜ã€‚</p>
  </li>
  <li>
    <p>å†…å®¹</p>

    <p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº† <strong>Tomcat</strong>çš„æ•´ä¸ªå¯åŠ¨çš„ç®€å•æµç¨‹ï¼ŒTomcatæºç ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯ <strong>Tomcat 7.0.67</strong>ã€‚</p>
  </li>
  <li>
    <p>ç›®çš„</p>

    <p>é€šè¿‡æœ¬æ–‡èƒ½å¤Ÿå¯¹ <strong>Tomcat</strong>çš„å¯åŠ¨æµç¨‹æœ‰åŸºæœ¬çš„è®¤è¯†ï¼Œä¸»è¦æ¶‰åŠåˆ°ä¸‰ä¸ªç±»ï¼šBootstrapï¼ŒCatalinaï¼ŒStandardServer.</p>
  </li>
</ul>

<h1 id="æµç¨‹åºåˆ—å›¾">æµç¨‹åºåˆ—å›¾</h1>

<p>â€‹é¦–å…ˆç»™å‡ºå¯åŠ¨Tomcat serverçš„ä¸€ä¸ªç®€å•åºåˆ—å›¾ï¼Œå¸Œæœ›å¤§å®¶åœ¨é˜…è¯»ä»£ç ä¹‹å‰ï¼Œå¯¹æ•´ä½“æµç¨‹æœ‰ä¸ªåŸºæœ¬çš„è®¤è¯†ï¼Œå¦‚ä¸‹å›¾ï¼š</p>

<p><img src="/assets/img/tomcat/start.png" alt="tomcat" /></p>
<h1 id="åˆå§‹åŒ–init">åˆå§‹åŒ–init</h1>

<h2 id="bootstrap-init">Bootstrap init</h2>

<h3 id="æºç è§£æ">æºç è§£æ</h3>

<pre><code class="language-java">
    /**
     * Bootstrap initæ–¹æ³•
     * Initialize daemon.
     */
    public void init() throws Exception
    {
        /**
         * è®¾ç½®baseå’Œhomeè·¯å¾„ï¼Œä¼˜å…ˆä½¿ç”¨
         **/
        setCatalinaHome();
        setCatalinaBase();
        /**
         * åˆå§‹åŒ–ç±»åŠ è½½å™¨ï¼ŒåŠ è½½ä¸‰ç§classloader
         * 1.common 2.share 3.server
         **/
        initClassLoaders();
        
        // è®¾ç½®å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡classloader
        Thread.currentThread().setContextClassLoader(catalinaLoader);

        // catalinaLoaderåŠ è½½tomcatç›¸å…³ç±»
        SecurityClassLoad.securityClassLoad(catalinaLoader);

        // åå°„ç”ŸæˆCatalinaç±»çš„å®ä¾‹
        if (log.isDebugEnabled())
            log.debug("Loading startup class");
        Class<?> startupClass =
            catalinaLoader.loadClass
            ("org.apache.catalina.startup.Catalina");
        Object startupInstance = startupClass.newInstance();

        /**
         * åå°„è·å–Catalinaçš„setParentClassLoaderæ–¹æ³•ï¼Œ
         * è°ƒç”¨è¯¥æ–¹æ³•è®¾ç½®shared classloaderä¸ºcatalinaçš„çˆ¶ç±»åŠ è½½å™¨
         **/
        if (log.isDebugEnabled())
            log.debug("Setting startup class properties");
        String methodName = "setParentClassLoader";
        Class<?> paramTypes[] = new Class[1];
        paramTypes[0] = Class.forName("java.lang.ClassLoader");
        Object paramValues[] = new Object[1];
        paramValues[0] = sharedLoader;
        Method method =
            startupInstance.getClass().getMethod(methodName, paramTypes);
        method.invoke(startupInstance, paramValues);
        
        // è·å–åˆ°catalinaçš„daemonå®ä¾‹
        catalinaDaemon = startupInstance;

    }
</code></pre>

<h1 id="åŠ è½½load">åŠ è½½load</h1>

<h2 id="bootstrap-load">Bootstrap load</h2>

<h3 id="æºç è§£æ-1">æºç è§£æ</h3>

<pre><code class="language-java">
    /**
     * Bootstrap loadæ–¹æ³•
     * Load daemon.
     */
    private void load(String[] arguments)
        throws Exception {
        
        String methodName = "load";
        Object param[];
        Class&lt;?&gt; paramTypes[];
        if (arguments==null || arguments.length==0) {
            paramTypes = null;
            param = null;
        } else {
            paramTypes = new Class[1];
            paramTypes[0] = arguments.getClass();
            param = new Object[1];
            param[0] = arguments;
        }
        // åå°„è·å–Catalinaçš„load()æ–¹æ³•ï¼ŒåŠ è½½ç›¸å…³å†…å®¹
        Method method =
            catalinaDaemon.getClass().getMethod(methodName, paramTypes);
        if (log.isDebugEnabled())
            log.debug("Calling startup class " + method);
        method.invoke(catalinaDaemon, param);

    }
</code></pre>

<h2 id="catalina-load">Catalina load</h2>

<h3 id="æºç è§£æ-2">æºç è§£æ</h3>

<pre><code class="language-java">
    /**
     * Catalina loadæ–¹æ³•
     * Start a new server instance.
     */
    public void load() {

        long t1 = System.nanoTime();

        initDirs();
        initNaming();

        /**
         * 1.åˆ›å»ºdigesterå¯¹è±¡ï¼Œé…ç½®ç›¸åº”çš„è§„åˆ™ --- line 17
         * 2.è¯»å–å¯¹åº”xmlæ–‡ä»¶ï¼Œä»¥æµçš„å½¢å¼å­˜å‚¨   --- line 19åˆ°74
         * 3.digesterå¯¹è±¡è§£æxmlæ–‡ä»¶ï¼Œä»¥stackçš„å½¢å¼å­˜å‚¨ï¼ŒæŒ‰ç…§é…ç½®çš„è§„åˆ™å®ä¾‹åŒ–
             Serverï¼ŒServiceï¼ŒConnectorç­‰å¯¹è±¡åŠå¯¹è±¡ä¹‹é—´çš„å…³ç³»ã€‚ --- line 77åˆ°97
         * 4.è°ƒç”¨StandardServerçš„initæ–¹æ³•ï¼Œåˆå§‹åŒ–Server
         **/
        Digester digester = createStartDigester();

        InputSource inputSource = null;
        InputStream inputStream = null;
        File file = null;
        try {
            try {
                // é»˜è®¤è¯»å–conf/server.xmlçš„é…ç½®ä¿¡æ¯
                file = configFile();
                inputStream = new FileInputStream(file);
                inputSource = new InputSource(file.toURI().toURL().toString());
            } catch (Exception e) {
                if (log.isDebugEnabled()) {
                    log.debug(sm.getString("catalina.configFail", file), e);
                }
            }
            if (inputStream == null) {
                try {
                    inputStream = getClass().getClassLoader()
                        .getResourceAsStream(getConfigFile());
                    inputSource = new InputSource
                        (getClass().getClassLoader()
                         .getResource(getConfigFile()).toString());
                } catch (Exception e) {
                    if (log.isDebugEnabled()) {
                        log.debug(sm.getString("catalina.configFail",
                                getConfigFile()), e);
                    }
                }
            }
            if( inputStream==null ) {
                try {
                    inputStream = getClass().getClassLoader()
                            .getResourceAsStream("server-embed.xml");
                    inputSource = new InputSource
                    (getClass().getClassLoader()
                            .getResource("server-embed.xml").toString());
                } catch (Exception e) {
                    if (log.isDebugEnabled()) {
                        log.debug(sm.getString("catalina.configFail",
                                "server-embed.xml"), e);
                    }
                }
            }
            if (inputStream == null || inputSource == null) {
                if  (file == null) {
                    log.warn(sm.getString("catalina.configFail",
                            getConfigFile() + "] or [server-embed.xml]"));
                } else {
                    log.warn(sm.getString("catalina.configFail",
                            file.getAbsolutePath()));
                    if (file.exists() &amp;&amp; !file.canRead()) {
                        log.warn("Permissions incorrect, read permission is not allowed on the file.");
                    }
                }
                return;
            }

            try {
                inputSource.setByteStream(inputStream);
                digester.push(this);
                digester.parse(inputSource);
            } catch (SAXParseException spe) {
                log.warn("Catalina.start using " + getConfigFile() + ": " +
                        spe.getMessage());
                return;
            } catch (Exception e) {
                log.warn("Catalina.start using " + getConfigFile() + ": " , e);
                return;
            }
        } finally {
            if (inputStream != null) {
                try {
                    inputStream.close();
                } catch (IOException e) {
                    // Ignore
                }
            }
        }

        getServer().setCatalina(this);

        // æ—¥å¿—è¾“å‡ºæµçš„é‡å®šä¹‰
        initStreams();

        try {
            // è°ƒç”¨StandardServerçš„initæ–¹æ³•
            getServer().init();
        } catch (LifecycleException e) {
                           if(Boolean.getBoolean("org.apache.catalina.startup.EXIT_ON_INIT_FAILURE")) {
                throw new java.lang.Error(e);
            } else {
                log.error("Catalina.start", e);
            }

        }

        long t2 = System.nanoTime();
        if(log.isInfoEnabled()) {
            log.info("Initialization processed in " + ((t2 - t1) / 1000000) + " ms");
        }

    }
</code></pre>

<p>Tomcatæºç åŸç”Ÿé…ç½®çš„server.xmlæ–‡ä»¶å¦‚ä¸‹ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;Server</span> <span class="na">port=</span><span class="s">"8005"</span> <span class="na">shutdown=</span><span class="s">"SHUTDOWN"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Listener</span> <span class="na">className=</span><span class="s">"org.apache.catalina.startup.VersionLoggerListener"</span> <span class="nt">/&gt;</span>
  <span class="c">&lt;!-- Security listener. Documentation at /docs/config/listeners.html
  &lt;Listener className="org.apache.catalina.security.SecurityListener" /&gt;
  --&gt;</span>
  <span class="c">&lt;!--APR library loader. Documentation at /docs/apr.html --&gt;</span>
  <span class="nt">&lt;Listener</span> <span class="na">className=</span><span class="s">"org.apache.catalina.core.AprLifecycleListener"</span> <span class="na">SSLEngine=</span><span class="s">"on"</span> <span class="nt">/&gt;</span>
  <span class="c">&lt;!--Initialize Jasper prior to webapps are loaded. Documentation at /docs/jasper-howto.html --&gt;</span>
  <span class="nt">&lt;Listener</span> <span class="na">className=</span><span class="s">"org.apache.catalina.core.JasperListener"</span> <span class="nt">/&gt;</span>
  <span class="c">&lt;!-- Prevent memory leaks due to use of particular java/javax APIs--&gt;</span>
  <span class="nt">&lt;Listener</span> <span class="na">className=</span><span class="s">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;Listener</span> <span class="na">className=</span><span class="s">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;Listener</span> <span class="na">className=</span><span class="s">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> <span class="nt">/&gt;</span>

  <span class="c">&lt;!-- Global JNDI resources
       Documentation at /docs/jndi-resources-howto.html
  --&gt;</span>
  <span class="nt">&lt;GlobalNamingResources&gt;</span>
    <span class="c">&lt;!-- Editable user database that can also be used by
         UserDatabaseRealm to authenticate users
    --&gt;</span>
    <span class="nt">&lt;Resource</span> <span class="na">name=</span><span class="s">"UserDatabase"</span> <span class="na">auth=</span><span class="s">"Container"</span>
              <span class="na">type=</span><span class="s">"org.apache.catalina.UserDatabase"</span>
              <span class="na">description=</span><span class="s">"User database that can be updated and saved"</span>
              <span class="na">factory=</span><span class="s">"org.apache.catalina.users.MemoryUserDatabaseFactory"</span>
              <span class="na">pathname=</span><span class="s">"conf/tomcat-users.xml"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/GlobalNamingResources&gt;</span>

  <span class="c">&lt;!-- A "Service" is a collection of one or more "Connectors" that share
       a single "Container" Note:  A "Service" is not itself a "Container",
       so you may not define subcomponents such as "Valves" at this level.
       Documentation at /docs/config/service.html
   --&gt;</span>
  <span class="nt">&lt;Service</span> <span class="na">name=</span><span class="s">"Catalina"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!--The connectors can use a shared executor, you can define one or more named thread pools--&gt;</span>
    <span class="c">&lt;!--
    &lt;Executor name="tomcatThreadPool" namePrefix="catalina-exec-"
        maxThreads="150" minSpareThreads="4"/&gt;
    --&gt;</span>

    <span class="c">&lt;!-- A "Connector" represents an endpoint by which requests are received
         and responses are returned. Documentation at :
         Java HTTP Connector: /docs/config/http.html (blocking &amp; non-blocking)
         Java AJP  Connector: /docs/config/ajp.html
         APR (HTTP/AJP) Connector: /docs/apr.html
         Define a non-SSL HTTP/1.1 Connector on port 8080
    --&gt;</span>
    <span class="nt">&lt;Connector</span> <span class="na">port=</span><span class="s">"8080"</span> <span class="na">protocol=</span><span class="s">"HTTP/1.1"</span>
               <span class="na">connectionTimeout=</span><span class="s">"20000"</span>
               <span class="na">redirectPort=</span><span class="s">"8443"</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- A "Connector" using the shared thread pool--&gt;</span>
    <span class="c">&lt;!--
    &lt;Connector executor="tomcatThreadPool"
               port="8080" protocol="HTTP/1.1"
               connectionTimeout="20000"
               redirectPort="8443" /&gt;
    --&gt;</span>
    <span class="c">&lt;!-- Define a SSL HTTP/1.1 Connector on port 8443
         This connector uses the BIO implementation that requires the JSSE
         style configuration. When using the APR/native implementation, the
         OpenSSL style configuration is required as described in the APR/native
         documentation --&gt;</span>
    <span class="c">&lt;!--
    &lt;Connector port="8443" protocol="org.apache.coyote.http11.Http11Protocol"
               maxThreads="150" SSLEnabled="true" scheme="https" secure="true"
               clientAuth="false" sslProtocol="TLS" /&gt;
    --&gt;</span>

    <span class="c">&lt;!-- Define an AJP 1.3 Connector on port 8009 --&gt;</span>
    <span class="nt">&lt;Connector</span> <span class="na">port=</span><span class="s">"8099"</span> <span class="na">protocol=</span><span class="s">"AJP/1.3"</span> <span class="na">redirectPort=</span><span class="s">"8443"</span> <span class="nt">/&gt;</span>


    <span class="c">&lt;!-- An Engine represents the entry point (within Catalina) that processes
         every request.  The Engine implementation for Tomcat stand alone
         analyzes the HTTP headers included with the request, and passes them
         on to the appropriate Host (virtual host).
         Documentation at /docs/config/engine.html --&gt;</span>

    <span class="c">&lt;!-- You should set jvmRoute to support load-balancing via AJP ie :
    &lt;Engine name="Catalina" defaultHost="localhost" jvmRoute="jvm1"&gt;
    --&gt;</span>
    <span class="nt">&lt;Engine</span> <span class="na">name=</span><span class="s">"Catalina"</span> <span class="na">defaultHost=</span><span class="s">"localhost"</span><span class="nt">&gt;</span>

      <span class="c">&lt;!--For clustering, please take a look at documentation at:
          /docs/cluster-howto.html  (simple how to)
          /docs/config/cluster.html (reference documentation) --&gt;</span>
      <span class="c">&lt;!--
      &lt;Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster"/&gt;
      --&gt;</span>

      <span class="c">&lt;!-- Use the LockOutRealm to prevent attempts to guess user passwords
           via a brute-force attack --&gt;</span>
      <span class="nt">&lt;Realm</span> <span class="na">className=</span><span class="s">"org.apache.catalina.realm.LockOutRealm"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- This Realm uses the UserDatabase configured in the global JNDI
             resources under the key "UserDatabase".  Any edits
             that are performed against this UserDatabase are immediately
             available for use by the Realm.  --&gt;</span>
        <span class="nt">&lt;Realm</span> <span class="na">className=</span><span class="s">"org.apache.catalina.realm.UserDatabaseRealm"</span>
               <span class="na">resourceName=</span><span class="s">"UserDatabase"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/Realm&gt;</span>

      <span class="nt">&lt;Host</span> <span class="na">name=</span><span class="s">"localhost"</span>  <span class="na">appBase=</span><span class="s">"webapps"</span> <span class="na">unpackWARs=</span><span class="s">"true"</span> <span class="na">autoDeploy=</span><span class="s">"true"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- SingleSignOn valve, share authentication between web applications
             Documentation at: /docs/config/valve.html --&gt;</span>
        <span class="c">&lt;!--
        &lt;Valve className="org.apache.catalina.authenticator.SingleSignOn" /&gt;
        --&gt;</span>
        <span class="c">&lt;!-- Access log processes all example.
             Documentation at: /docs/config/valve.html
             Note: The pattern used is equivalent to using pattern="common" --&gt;</span>
        <span class="nt">&lt;Valve</span> <span class="na">className=</span><span class="s">"org.apache.catalina.valves.AccessLogValve"</span>
               <span class="na">directory=</span><span class="s">"logs"</span>  <span class="na">prefix=</span><span class="s">"localhost_access_log."</span> <span class="na">suffix=</span><span class="s">".txt"</span>
               <span class="na">pattern=</span><span class="s">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> <span class="nt">/&gt;</span>

      <span class="nt">&lt;/Host&gt;</span>
    <span class="nt">&lt;/Engine&gt;</span>
  <span class="nt">&lt;/Service&gt;</span>
<span class="nt">&lt;/Server&gt;</span>

</code></pre></div></div>

<p>â€‹   æˆ‘ä»¬å¯ä»¥çœ‹åˆ°Serveræ ‡ç­¾ä¸‹é¢é…ç½®äº†ä¸€ä¸ªå•ç‹¬çš„Serviceï¼ŒServiceæ ‡ç­¾ä¸‹é¢é…ç½®äº†å¤šä¸ªConnectorï¼ŒåŸºäºä¸åŒåè®®æœ‰ä¸åŒçš„Connectorï¼Œä¾‹å¦‚httpã€ajpã€aprç­‰ï¼ŒConnectorç”¨äºæ¥å—requestå’Œresponseï¼ŒçœŸæ­£å¤„ç†è¯·æ±‚çš„æ˜¯å†…éƒ¨çš„Containerï¼Œå¯¹åº”çš„æ˜¯Engineæ ‡ç­¾ï¼Œä¸€ä¸ªContainerå…±äº«å¤šä¸ªConnectorã€‚</p>

<h3 id="éœ€è¦æ³¨æ„çš„åœ°æ–¹">éœ€è¦æ³¨æ„çš„åœ°æ–¹</h3>

<p>â€‹   <a href="https://tomcat.apache.org/tomcat-7.0-doc/api/index.html">Digester</a>æ®è¯´æ˜¯Apache Strutsé¡¹ç›®ä¸­ç”¨æ¥è§£æxmlæ–‡ä»¶çš„ä¸€ä¸ªapiï¼Œåæ¥ç›´æ¥è¿ç”¨åˆ°Tomcaté¡¹ç›®ä¸­ï¼Œå¯¹äºStrutsä¸å¤ªäº†è§£ï¼Œä½†æ˜¯è¿™ç§å®ä¾‹åŒ–å¯¹è±¡çš„æ–¹æ³•ä½¿ç”¨ä¸Šæ„Ÿè§‰æœ‰ç‚¹è‡ƒè‚¿è€Œä¸”æ™¦æ¶©éš¾æ‡‚ï¼Œä¸å¤ªäº†è§£ä½¿ç”¨è¿™ç§æ–¹æ³•çš„åŸå› ä»¥åŠä¼˜åŠ¿ã€‚</p>

<h2 id="standardserver-init">StandardServer init</h2>

<h3 id="æºç è§£æ-3">æºç è§£æ</h3>

<pre><code class="language-java">
    /**
     * StandardServer åˆå§‹åŒ–
     */
    protected void initInternal() throws LifecycleException {
        
        super.initInternal();

        // jmxç›¸å…³åˆå§‹åŒ–
        onameStringCache = register(new StringCache(), "type=StringCache");

        MBeanFactory factory = new MBeanFactory();
        factory.setContainer(this);
        onameMBeanFactory = register(factory, "type=MBeanFactory");
        
        // JNDIç›¸å…³èµ„æºåˆå§‹åŒ–
        globalNamingResources.init();
        
        // åŠ è½½ç›¸å…³èµ„æºçš„jar
        if (getCatalina() != null) {
            ClassLoader cl = getCatalina().getParentClassLoader();
            // Walk the class loader hierarchy. Stop at the system class loader.
            // This will add the shared (if present) and common class loaders
            while (cl != null &amp;&amp; cl != ClassLoader.getSystemClassLoader()) {
                if (cl instanceof URLClassLoader) {
                    URL[] urls = ((URLClassLoader) cl).getURLs();
                    for (URL url : urls) {
                        if (url.getProtocol().equals("file")) {
                            try {
                                File f = new File (url.toURI());
                                if (f.isFile() &amp;&amp;
                                        f.getName().endsWith(".jar")) {
                                    ExtensionValidator.addSystemResource(f);
                                }
                            } catch (URISyntaxException e) {
                                // Ignore
                            } catch (IOException e) {
                                // Ignore
                            }
                        }
                    }
                }
                cl = cl.getParent();
            }
        }
        // server.xmlé…ç½®çš„serviceåˆå§‹åŒ–
        for (int i = 0; i &lt; services.length; i++) {
            services[i].init();
        }
    }
</code></pre>

<h3 id="éœ€è¦æ³¨æ„çš„åœ°æ–¹-1">éœ€è¦æ³¨æ„çš„åœ°æ–¹</h3>

<p>â€‹   è¿™é‡Œçœç•¥äº†ä¸€äº›è°ƒç”¨æ­¥éª¤ï¼Œåº”è¯¥ä¼šæœ‰äººå¥‡æ€ªï¼Œä¸ºä»€ä¹ˆä¹‹å‰è°ƒç”¨çš„æ˜¯initæ–¹æ³•ï¼Œåˆ°è¿™é‡Œæ€ä¹ˆå˜æˆäº†initInternalæ–¹æ³•äº†ï¼ŸåŸå› æ˜¯StandardServeræ²¡æœ‰å®ç°initæ–¹æ³•ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº†çˆ¶æŠ½è±¡ç±»çš„LifecycleBaseçš„initæ–¹æ³•ï¼Œçˆ¶ç±»çš„initæ–¹æ³•å†…éƒ¨è°ƒç”¨äº†æŠ½è±¡æ–¹æ³•initInternalï¼Œè€ŒæŠ½è±¡æ–¹æ³•initInternalåœ¨ä¸åŒçš„å­ç±»ä¸­æœ‰ä¸åŒçš„å®ç°ï¼Œå°†æŠ½è±¡ç±»çš„å…¬å…±æ–¹æ³•å’Œä¸åŒå­ç±»çš„å®ç°ç»“åˆèµ·æ¥ï¼Œè¿™æ˜¯æŠ½è±¡ç±»çš„ä¸€ç§åº”ç”¨åœºæ™¯ã€‚Tomcatç”Ÿå‘½å‘¨æœŸç®¡ç†çš„ä»£ç ç»“æ„å°±æ˜¯è¿™ç§æ–¹å¼æ¥ï¼ŒåŒ…æ‹¬ä¸‹é¢<strong>StandardServer start</strong>è¿™ä¸€å°èŠ‚ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œåé¢ä¼šä¸“é—¨è¿›è¡Œä»‹ç»ã€‚</p>

<h1 id="å¯åŠ¨start">å¯åŠ¨start</h1>

<h2 id="bootstrap-start">Bootstrap start</h2>

<h3 id="æºç è§£æ-4">æºç è§£æ</h3>

<pre><code class="language-java">
    /**
     * Bootstrap start
     */
    public void start() throws Exception {
        // å¦‚æœæ²¡æœ‰åˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–
        if( catalinaDaemon==null ) 
            init();
        
        // åå°„æ‰§è¡ŒCatalinaçš„startæ–¹æ³•
        Method method = catalinaDaemon.getClass().getMethod("start",(Class [])null);
        method.invoke(catalinaDaemon, (Object [])null);

    }
</code></pre>

<h2 id="catalina-start">Catalina start</h2>

<h3 id="æºç è§£æ-5">æºç è§£æ</h3>

<pre><code class="language-java">
    /**
     * Catalina start.
     */
    public void start() {
        // è‹¥StandardServeræœªåˆå§‹åŒ–ï¼Œå…ˆæ‰§è¡Œloadæ–¹æ³•åˆå§‹åŒ–StandardServer
        if (getServer() == null) {
            load();
        }

        if (getServer() == null) {
            log.fatal("Cannot start server. Server instance is not configured.");
            return;
        }

        long t1 = System.nanoTime();

        // å¯åŠ¨StandardServer
        try {
            getServer().start();
        } catch (LifecycleException e) {
            log.fatal(sm.getString("catalina.serverStartFail"), e);
            try {
                getServer().destroy();
            } catch (LifecycleException e1) {
                log.debug("destroy() failed for failed Server ", e1);
            }
            return;
        }

        long t2 = System.nanoTime();
        if(log.isInfoEnabled()) {
            log.info("Server startup in " + ((t2 - t1) / 1000000) + " ms");
        }

        /**
         * æ³¨å†Œåå°shutdown hookï¼Œç”¨æ¥å¤„ç†tomcatçš„shutdownæ“ä½œ
         * æ›¾åœ¨skywalkingçš„æºç ä¸­ä¹Ÿçœ‹åˆ°è¿‡ç±»ä¼¼çš„å¤„ç†ï¼Œä¸€èˆ¬éƒ½æ˜¯å¯åŠ¨daemonå®ˆæŠ¤çº¿ç¨‹ï¼Œ
         * ç”¨æ¥å¤„ç†å…³é—­èµ„æºç­‰æ“ä½œ
         **/
        if (useShutdownHook) {
            if (shutdownHook == null) {
                shutdownHook = new CatalinaShutdownHook();
            }
            Runtime.getRuntime().addShutdownHook(shutdownHook);

            // If JULI is being used, disable JULI's shutdown hook since
            // shutdown hooks run in parallel and log messages may be lost
            // if JULI's hook completes before the CatalinaShutdownHook()
            LogManager logManager = LogManager.getLogManager();
            if (logManager instanceof ClassLoaderLogManager) {
                ((ClassLoaderLogManager) logManager).setUseShutdownHook(
                        false);
            }
        }

        
        if (await) {
            await();
            stop();
        }
    }
</code></pre>

<h2 id="standardserver-start">StandardServer start</h2>

<h3 id="æºç è§£æ-6">æºç è§£æ</h3>

<pre><code class="language-java">
    /**
     * StandardServer start
     */
    protected void startInternal() throws LifecycleException {
        //ç”Ÿå‘½å‘¨æœŸåŠå…¶çŠ¶æ€çš„å˜åŒ–
        fireLifecycleEvent(CONFIGURE_START_EVENT, null);
        setState(LifecycleState.STARTING);

        //JNDIèµ„æºå¯åŠ¨
        globalNamingResources.start();

        // å¯åŠ¨serverå†…éƒ¨çš„standard service
        synchronized (services) {
            for (int i = 0; i &lt; services.length; i++) {
                services[i].start();
            }
        }
    }
</code></pre>

<h1 id="æ€»ç»“">æ€»ç»“</h1>

<ul>
  <li><strong>Tomcat</strong>æœ¬è´¨æ˜¯ä¸€ä¸ªwebå®¹å™¨ï¼Œå®¹å™¨é€šè¿‡Javaçš„ç±»åŠ è½½æœºåˆ¶ï¼ˆclassloaderï¼‰æ¥åŠ è½½ <strong>Tomcat</strong>æ‰€éœ€è¦çš„ç±»ï¼ˆclassï¼‰ï¼Œå†é€šè¿‡åå°„æœºåˆ¶å®ä¾‹åŒ–å¯¹è±¡ï¼Œæ•´ä¸ª <strong>Tomcat</strong>åœ¨é…ç½®æ–‡ä»¶å’Œxmlæ–‡ä»¶çš„è§£æä¸­å¤§é‡ä½¿ç”¨äº†è¯¥æœºåˆ¶ï¼Œå’ŒspringåŸºäºé…ç½®ç¼–ç¨‹çš„åŸºæœ¬æ€æƒ³æ˜¯ä¸€è‡´çš„ã€‚</li>
  <li>æ•´ä¸ª <strong>Tomcat</strong>çš„å¯åŠ¨ä¸ä»…ä»…åŒ…å«äº†ä¸Šé¢è¿™å‡ ä¸ªç»„ä»¶çš„å¯åŠ¨ï¼Œè¿˜åŒ…å«äº†å„ç§ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå’ŒçŠ¶æ€çš„ç®¡ç†ç­‰ç­‰ï¼Œæ˜¯ä¸ªéå¸¸å¤æ‚çš„è¿‡ç¨‹ï¼Œä¸Šé¢è¿™ä¸ªæ–‡ç« åªæ˜¯ç®€å•æè¿°äº† <strong>Tomcat</strong>å¯åŠ¨è¿‡ç¨‹ä¸­ç›¸å¯¹é‡è¦çš„å‡ ä¸ªç»„ä»¶ï¼Œç”±äºè¿™éƒ¨åˆ†å†…å®¹å¾ˆå¤šï¼Œåç»­è¿˜ä¼šå¯¹<strong>Tomcat</strong>ä¸­ä½¿ç”¨åˆ°çš„é‡è¦ç»„ä»¶å•ç‹¬è¿›è¡Œæ›´åŠ è¯¦ç»†çš„ä»‹ç»ã€‚</li>
</ul>

:ET